name: Publish Tutopanda CLI

on:
  push:
    tags:
      - "cli-v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Optional tag/ref to publish (e.g., cli-v1.0.1). If empty, use the checked-out ref."
        required: false
        default: ""
      dry_run:
        description: "When true, run the full pipeline but skip npm publish."
        required: false
        type: boolean
        default: false

permissions:
  id-token: write  # Required for OIDC
  contents: read

jobs:
  publish-cli:
    name: Build and publish tutopanda-cli
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      NODE_VERSION: "20"
      PNPM_VERSION: "10.15.0"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.tag || github.ref }}
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: https://registry.npmjs.org
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build and pack CLI (bundles viewer)
        run: pnpm package:cli

      - name: Locate packaged tarball
        id: tarball
        run: |
          TARBALL=$(ls release/tutopanda-cli-*.tgz | head -n 1)
          if [ -z "$TARBALL" ]; then
            echo "No packaged tarball found in release/"; exit 1;
          fi
          echo "path=$TARBALL" >> "$GITHUB_OUTPUT"

      - name: Verify viewer bundle inside tarball
        run: |
          tar -tf "${{ steps.tarball.outputs.path }}" | grep -q "package/config/viewer/dist/index.html"
          tar -tf "${{ steps.tarball.outputs.path }}" | grep -q "package/config/viewer/server-dist/bin.js"

      - name: Smoke test CLI help
        run: node cli/dist/cli.js --help

      - name: Publish to npm
        if: >
          (github.event_name == 'workflow_dispatch' && inputs.dry_run == false) ||
          (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/cli-v'))
        run: npm publish "${{ steps.tarball.outputs.path }}" --access public

      - name: Upload packaged artifact
        uses: actions/upload-artifact@v4
        with:
          name: tutopanda-cli-tarball
          path: ${{ steps.tarball.outputs.path }}
